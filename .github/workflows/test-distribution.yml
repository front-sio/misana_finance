name: Test Distribution Portal

on:
  workflow_run:
    workflows: ["Build Android App (Flutter)"]
    types:
      - completed
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-test-portal:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate test distribution portal
        run: |
          mkdir -p dist
          
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Misana Finance - Beta Testing Portal</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
              <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
              <style>
                  .gradient-bg { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); }
                  .card-hover { transition: all 0.3s ease; }
                  .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
              </style>
          </head>
          <body class="bg-gray-50 min-h-screen">
              <div class="gradient-bg text-white py-16">
                  <div class="container mx-auto px-4 text-center">
                      <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-20 rounded-full mb-6">
                          <i class="fas fa-mobile-alt text-3xl"></i>
                      </div>
                      <h1 class="text-4xl md:text-5xl font-bold mb-4">Misana Finance</h1>
                      <p class="text-xl md:text-2xl text-orange-100 mb-2">Beta Testing Portal</p>
                      <p class="text-orange-200 max-w-2xl mx-auto">Download the latest builds and help us test the future of financial services</p>
                  </div>
              </div>

              <div class="container mx-auto px-4 py-12">
                  <div class="max-w-6xl mx-auto">
                      <div class="grid lg:grid-cols-3 gap-8">
                          <div class="lg:col-span-2">
                              <div class="bg-white rounded-2xl shadow-lg p-8 card-hover mb-8">
                                  <div class="flex items-center justify-between mb-6">
                                      <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                          <i class="fas fa-download text-orange-500 mr-3"></i>
                                          Latest Build
                                      </h2>
                                      <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                          <i class="fas fa-check-circle mr-1"></i>Ready
                                      </span>
                                  </div>
                                  
                                  <div class="grid md:grid-cols-2 gap-6 mb-8">
                                      <div class="space-y-3">
                                          <h3 class="font-semibold text-gray-700 text-lg">Build Information</h3>
                                          <div class="space-y-2 text-sm">
                                              <div class="flex justify-between">
                                                  <span class="text-gray-600">Version:</span>
                                                  <span class="font-medium text-gray-800">v1.0.0</span>
                                              </div>
                                              <div class="flex justify-between">
                                                  <span class="text-gray-600">Platform:</span>
                                                  <span class="font-medium text-gray-800">Android</span>
                                              </div>
                                              <div class="flex justify-between">
                                                  <span class="text-gray-600">Type:</span>
                                                  <span class="font-medium text-gray-800">Debug Build</span>
                                              </div>
                                              <div class="flex justify-between">
                                                  <span class="text-gray-600">API:</span>
                                                  <span class="font-medium text-blue-600">misana.stebofarm.co.tz</span>
                                              </div>
                                              <div class="flex justify-between">
                                                  <span class="text-gray-600">Updated:</span>
                                                  <span class="font-medium text-gray-800" id="last-updated">Loading...</span>
                                              </div>
                                          </div>
                                      </div>
                                      
                                      <div class="space-y-4">
                                          <h3 class="font-semibold text-gray-700 text-lg">Download Options</h3>
                                          <div class="space-y-3">
                                              <button onclick="downloadLatest('arm64')" 
                                                     class="w-full flex items-center justify-between bg-orange-500 hover:bg-orange-600 text-white px-6 py-4 rounded-xl transition-all duration-300 group shadow-lg">
                                                  <span class="flex items-center font-semibold">
                                                      <i class="fas fa-mobile-alt mr-3"></i>
                                                      ARM64 (Recommended)
                                                  </span>
                                                  <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                              </button>
                                              <button onclick="downloadLatest('universal')"
                                                     class="w-full flex items-center justify-between bg-gray-600 hover:bg-gray-700 text-white px-6 py-4 rounded-xl transition-all duration-300 group shadow-lg">
                                                  <span class="flex items-center font-semibold">
                                                      <i class="fas fa-download mr-3"></i>
                                                      Universal APK
                                                  </span>
                                                  <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                              </button>
                                          </div>
                                      </div>
                                  </div>

                                  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                                      <h4 class="font-semibold text-blue-800 mb-4 text-lg flex items-center">
                                          <i class="fas fa-info-circle mr-2"></i>Installation Guide
                                      </h4>
                                      <div class="grid md:grid-cols-2 gap-4 text-sm text-blue-700">
                                          <ol class="space-y-2">
                                              <li class="flex items-start">
                                                  <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-3 mt-0.5 flex-shrink-0">1</span>
                                                  Download APK to your Android device
                                              </li>
                                              <li class="flex items-start">
                                                  <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-3 mt-0.5 flex-shrink-0">2</span>
                                                  Enable "Install from Unknown Sources"
                                              </li>
                                          </ol>
                                          <ol class="space-y-2">
                                              <li class="flex items-start">
                                                  <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-3 mt-0.5 flex-shrink-0">3</span>
                                                  Open downloaded APK and install
                                              </li>
                                              <li class="flex items-start">
                                                  <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-3 mt-0.5 flex-shrink-0">4</span>
                                                  Launch "Misana Finance" app
                                              </li>
                                          </ol>
                                      </div>
                                  </div>
                              </div>

                              <div class="bg-white rounded-2xl shadow-lg p-8 card-hover">
                                  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                      <i class="fas fa-history text-gray-500 mr-3"></i>
                                      Previous Builds
                                  </h2>
                                  <div id="builds-list" class="space-y-4">
                                      <div class="text-center text-gray-500 py-8">
                                          <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                                          <p>Loading previous builds...</p>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <div class="space-y-8">
                              <div class="bg-white rounded-2xl shadow-lg p-8 card-hover">
                                  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                      <i class="fas fa-tasks text-orange-500 mr-3"></i>
                                      Testing Checklist
                                  </h2>
                                  <div class="space-y-3 text-sm">
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>App launch & splash screen</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>User registration flow</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>Login authentication</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>KYC verification process</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>Dashboard navigation</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>Financial operations</span>
                                      </label>
                                      <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                          <input type="checkbox" class="mr-3 text-orange-500 rounded">
                                          <span>API connectivity</span>
                                      </label>
                                  </div>
                              </div>

                              <div class="bg-white rounded-2xl shadow-lg p-8 card-hover">
                                  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                      <i class="fas fa-comments text-green-500 mr-3"></i>
                                      Feedback & Support
                                  </h2>
                                  <div class="space-y-4">
                                      <a href="https://github.com/${{ github.repository }}/issues/new" 
                                         target="_blank"
                                         class="flex items-center p-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors duration-300 group">
                                          <i class="fas fa-bug text-red-500 text-xl mr-4"></i>
                                          <div>
                                              <h3 class="font-semibold text-gray-800 group-hover:text-red-700">Report Bug</h3>
                                              <p class="text-sm text-gray-600">Found an issue? Let us know!</p>
                                          </div>
                                      </a>
                                      <a href="https://github.com/${{ github.repository }}/discussions" 
                                         target="_blank"
                                         class="flex items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors duration-300 group">
                                          <i class="fas fa-lightbulb text-blue-500 text-xl mr-4"></i>
                                          <div>
                                              <h3 class="font-semibold text-gray-800 group-hover:text-blue-700">Suggestions</h3>
                                              <p class="text-sm text-gray-600">Share ideas and feedback</p>
                                          </div>
                                      </a>
                                      <a href="mailto:support@misana.stebofarm.co.tz" 
                                         class="flex items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition-colors duration-300 group">
                                          <i class="fas fa-envelope text-green-500 text-xl mr-4"></i>
                                          <div>
                                              <h3 class="font-semibold text-gray-800 group-hover:text-green-700">Direct Support</h3>
                                              <p class="text-sm text-gray-600">Email us directly</p>
                                          </div>
                                      </a>
                                  </div>
                              </div>

                              <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl shadow-lg p-8 text-white">
                                  <h2 class="text-xl font-bold mb-4 flex items-center">
                                      <i class="fas fa-rocket mr-3"></i>
                                      Quick Stats
                                  </h2>
                                  <div class="space-y-3 text-sm">
                                      <div class="flex justify-between">
                                          <span class="text-orange-100">Total Builds:</span>
                                          <span class="font-semibold" id="total-builds">-</span>
                                      </div>
                                      <div class="flex justify-between">
                                          <span class="text-orange-100">Last Build:</span>
                                          <span class="font-semibold" id="last-build">-</span>
                                      </div>
                                      <div class="flex justify-between">
                                          <span class="text-orange-100">Success Rate:</span>
                                          <span class="font-semibold" id="success-rate">-</span>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <footer class="bg-gray-800 text-gray-300 py-8">
                  <div class="container mx-auto px-4 text-center">
                      <p>&copy; 2024 Misana Finance. All rights reserved.</p>
                      <p class="text-sm text-gray-400 mt-2">
                          API: <span class="text-orange-400">https://misana.stebofarm.co.tz</span>
                      </p>
                  </div>
              </footer>

              <script>
                  document.getElementById('last-updated').textContent = new Date().toLocaleDateString();

                  function downloadLatest(type) {
                      const repoUrl = 'https://github.com/${{ github.repository }}';
                      const actionsUrl = `${repoUrl}/actions`;
                      window.open(actionsUrl, '_blank');
                      
                      if ('gtag' in window) {
                          gtag('event', 'download_click', {
                              'build_type': type,
                              'timestamp': new Date().toISOString()
                          });
                      }
                  }

                  async function loadPreviousBuilds() {
                      try {
                          const response = await fetch('https://api.github.com/repos/${{ github.repository }}/actions/runs?event=push&status=success&per_page=8');
                          const data = await response.json();
                          
                          const buildsList = document.getElementById('builds-list');
                          buildsList.innerHTML = '';

                          if (data.workflow_runs && data.workflow_runs.length > 0) {
                              data.workflow_runs.forEach((run, index) => {
                                  const buildItem = document.createElement('div');
                                  buildItem.className = 'flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors duration-300';
                                  buildItem.innerHTML = `
                                      <div class="flex items-center">
                                          <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-sm mr-4">
                                              #${run.run_number}
                                          </div>
                                          <div>
                                              <h4 class="font-medium text-gray-800">Build #${run.run_number}</h4>
                                              <p class="text-sm text-gray-600">${new Date(run.created_at).toLocaleDateString()}</p>
                                              <p class="text-xs text-gray-500 truncate max-w-xs">${run.head_commit?.message || 'No commit message'}</p>
                                          </div>
                                      </div>
                                      <a href="${run.html_url}" target="_blank" 
                                         class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-300 flex items-center">
                                          <i class="fas fa-external-link-alt mr-2"></i>View
                                      </a>
                                  `;
                                  buildsList.appendChild(buildItem);
                              });

                              // Update stats
                              document.getElementById('total-builds').textContent = data.total_count || data.workflow_runs.length;
                              document.getElementById('last-build').textContent = new Date(data.workflow_runs[0].created_at).toLocaleDateString();
                              document.getElementById('success-rate').textContent = '100%';
                          } else {
                              buildsList.innerHTML = '<div class="text-center text-gray-500 py-8">No previous builds found</div>';
                          }
                      } catch (error) {
                          console.error('Failed to load builds:', error);
                          document.getElementById('builds-list').innerHTML = 
                              '<div class="text-center text-gray-500 py-8">Failed to load previous builds</div>';
                      }
                  }

                  loadPreviousBuilds();
              </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: ${{ github.repository_owner }}.github.io